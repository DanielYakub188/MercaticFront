<div class="container mt-4">
  <h2>Mis Pedidos</h2>

  <!-- Botones de filtro -->
  <div class="mb-3">
    <button
      class="btn btn-outline-primary me-2"
      [class.active]="filtro === 'TODOS'"
      (click)="aplicarFiltro('TODOS')"
    >
      Todos
    </button>
    <button
      class="btn btn-outline-success me-2"
      [class.active]="filtro === 'EN_CURSO'"
      (click)="aplicarFiltro('EN_CURSO')"
    >
      En curso
    </button>
    <button
      class="btn btn-outline-secondary me-2"
      [class.active]="filtro === 'FINALIZADO'"
      (click)="aplicarFiltro('FINALIZADO')"
    >
      Finalizados
    </button>
    <button
      class="btn btn-outline-danger"
      [class.active]="filtro === 'CANCELADO'"
      (click)="aplicarFiltro('CANCELADO')"
    >
      Cancelados
    </button>
  </div>

  <!-- Tabla de pedidos -->
  <table class="table table-striped mt-3" *ngIf="pedidosPaginados.length > 0">
    <thead>
      <tr>
        <th>ID Pedido</th>
        <th>Estado</th>
        <th>Usuario</th>
        <th>Dirección</th>
        <th>Total (€)</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of pedidosPaginados">
        <td>{{ p.id }}</td>
        <td>{{ p.estado }}</td>
        <td>{{ p.usuario.datosUsuario?.nombre || p.usuario.correoElectronico }}</td>
        <td>{{ p.usuario.datosUsuario?.direccion || "Sin dirección" }} {{ p.usuario.datosUsuario?.localidad || '' }}</td>
        <td>{{ p.total | currency : "EUR" }}</td>
        <td>
          <button class="btn btn-primary btn-sm" (click)="abrirPedido(p)">
            Ver Pedido
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <p *ngIf="pedidosPaginados.length === 0" class="text-center mt-4">
    No tienes pedidos en esta categoría.
  </p>

  <!-- Paginación -->
  <div class="d-flex justify-content-between mt-3" *ngIf="pedidosFiltrados.length > 0">
    <button class="btn btn-outline-primary" [disabled]="paginaActual === 1" (click)="anteriorPagina()">
      Anterior
    </button>
    <span>Página {{ paginaActual }} / {{ totalPaginas() }}</span>
    <button class="btn btn-outline-primary" [disabled]="paginaActual >= totalPaginas()" (click)="siguientePagina()">
      Siguiente
    </button>
  </div>
</div>

<!-- Modal para ver pedido -->
<div class="modal fade" id="modalPedido" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 14px">
      <div class="modal-header">
        <h5 class="modal-title">Pedido #{{ pedidoSeleccionado?.id }}</h5>
        <button class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered" *ngIf="pedidoSeleccionado">
          <thead>
            <tr>
              <th>Imagen</th>
              <th>Producto</th>
              <th>Categoría</th>
              <th>Formato</th>
              <th>Precio</th>
              <th>Unidades</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prod of pedidoSeleccionado.productos">
              <td>
                <img
                  [src]="'http://localhost:8080/uploads/productos/' + prod.imagenUrl"
                  alt="img"
                  width="70"
                  height="70"
                  style="object-fit: cover; border-radius: 6px"
                />
              </td>
              <td>{{ prod.nombreProducto }}</td>
              <td>{{ prod.categoria }}</td>
              <td>{{ prod.formatoProducto }}</td>
              <td>{{ prod.precio | currency : "EUR" }}</td>
              <td>{{ prod.stock }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
        <button
          *ngIf="pedidoSeleccionado?.estado === 'EN_CURSO'"
          class="btn btn-danger"
          (click)="cancelarPedido(pedidoSeleccionado!)"
        >
          Cancelar Pedido
        </button>
      </div>
    </div>
  </div>
</div>
